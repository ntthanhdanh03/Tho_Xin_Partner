import React, { useState } from 'react'
import { StyleSheet, View, Text, ScrollView, Image, TouchableOpacity } from 'react-native'
import { SafeAreaView } from 'react-native-safe-area-context'
import { DefaultStyles } from '../../styles/DefaultStyles'
import { Colors } from '../../styles/Colors'
import { useTranslation } from 'react-i18next'
import Header from '../components/Header'
import Button from '../components/Button'
import CustomModal from './CustomModal'
import Input from '../components/Input'
import Spacer from '../components/Spacer'
import { useDispatch, useSelector } from 'react-redux'
import { applicantOrderAction } from '../../store/actions/orderAction'
import GlobalModalController from '../components/GlobalModal/GlobalModalController'
import { useNavigation } from '@react-navigation/native'
import { getChatRoomByApplicantAction } from '../../store/actions/chatAction'
import ImageViewing from 'react-native-image-viewing'

// ‚öôÔ∏è H√†m ƒë·ªãnh d·∫°ng ti·ªÅn VNƒê
const formatCurrency = (value: string) => {
    if (!value) return ''
    const numeric = value.replace(/\D/g, '')
    if (!numeric) return ''
    return numeric.replace(/\B(?=(\d{3})+(?!\d))/g, '.')
}

const DetailOrderView = ({ route }: any) => {
    const { t } = useTranslation()
    const dispatch = useDispatch()
    const navigation = useNavigation()
    const { data: authData } = useSelector((store: any) => store.auth)
    const { item } = route.params

    const [isModalVisible, setIsModalVisible] = useState(false)
    const [price, setPrice] = useState('')
    const [note, setNote] = useState('')

    // üëá State cho tr√¨nh xem ·∫£nh
    const [isImageViewVisible, setIsImageViewVisible] = useState(false)
    const [imageIndex, setImageIndex] = useState(0)
    const images = item.images || []

    const handleApplicant = () => {
        const postData = {
            partnerId: authData?.user?._id,
            name: authData?.user?.fullName,
            avatarUrl: authData?.user?.avatarUrl,
            offeredPrice: price,
            note: note,
        }

        dispatch(
            applicantOrderAction(
                {
                    id: item._id,
                    postData,
                },
                (data: any, error: any) => {
                    if (data) {
                        GlobalModalController.showModal({
                            title: 'B√°o gi√° th√†nh c√¥ng',
                            description: error || 'B√°o gi√° th√†nh c√¥ng',
                            icon: 'success',
                        })
                        dispatch(getChatRoomByApplicantAction({ _applicantId: authData.user._id }))
                        navigation.goBack()
                        setIsModalVisible(false)
                    } else {
                        GlobalModalController.showModal({
                            title: 'B√°o gi√° th·∫•t b·∫°i',
                            description: error || 'Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin',
                            icon: 'fail',
                        })
                        setIsModalVisible(false)
                    }
                },
            ),
        )
    }

    return (
        <SafeAreaView style={[DefaultStyles.container]} edges={['top']}>
            <Header isBack title="Chi Ti·∫øt Y√™u C·∫ßu" />

            <ScrollView style={styles.content} showsVerticalScrollIndicator={false}>
                {/* --- Th√¥ng tin d·ªãch v·ª• --- */}
                <View style={styles.serviceCard}>
                    <View style={styles.serviceHeader}>
                        <Text style={[DefaultStyles.textBold16Black, { flex: 1 }]}>
                            {item.service}
                        </Text>
                    </View>
                </View>

                <View style={styles.section}>
                    <Text style={[DefaultStyles.textMedium14Black, { marginBottom: 8 }]}>
                        M√¥ t·∫£ t√¨nh tr·∫°ng
                    </Text>
                    <Text style={[DefaultStyles.textRegular16Black, { lineHeight: 22 }]}>
                        {item.describe}
                    </Text>
                </View>

                <View style={styles.section}>
                    <Text style={[DefaultStyles.textMedium14Black, { marginBottom: 6 }]}>
                        üìç ƒê·ªãa ch·ªâ
                    </Text>
                    <Text style={[DefaultStyles.textRegular16Black]}>{item.address}</Text>
                </View>

                <View style={styles.section}>
                    <Text style={[DefaultStyles.textMedium14Black, { marginBottom: 6 }]}>
                        Gi√° tham kh·∫£o
                    </Text>
                    <View style={styles.priceBox}>
                        <Text style={[DefaultStyles.textBold16Black, { color: Colors.green34 }]}>
                            {item.rangePrice}
                        </Text>
                    </View>
                </View>

                {/* --- H√¨nh ·∫£nh --- */}
                <View style={styles.section}>
                    <Text style={[DefaultStyles.textMedium14Black, { marginBottom: 10 }]}>
                        H√¨nh ·∫£nh
                    </Text>
                    {images.length > 0 ? (
                        <ScrollView
                            horizontal
                            showsHorizontalScrollIndicator={false}
                            style={{ marginLeft: -16 }}
                        >
                            {images.map((uri: string, index: number) => (
                                <TouchableOpacity
                                    key={index}
                                    activeOpacity={0.9}
                                    onPress={() => {
                                        setImageIndex(index)
                                        setIsImageViewVisible(true)
                                    }}
                                >
                                    <Image source={{ uri }} style={styles.imageItem} />
                                </TouchableOpacity>
                            ))}
                        </ScrollView>
                    ) : (
                        <Text style={[DefaultStyles.textRegular13Gray]}>Kh√¥ng c√≥ h√¨nh ·∫£nh</Text>
                    )}
                </View>

                {/* üëá Tr√¨nh xem ·∫£nh to√†n m√†n h√¨nh */}
                <ImageViewing
                    images={images.map((uri: string) => ({ uri }))}
                    imageIndex={imageIndex}
                    visible={isImageViewVisible}
                    onRequestClose={() => setIsImageViewVisible(false)}
                    HeaderComponent={({ imageIndex }) => (
                        <View style={styles.headerIndicator}>
                            <Text style={styles.indicatorText}>
                                {imageIndex + 1} / {images.length}
                            </Text>
                        </View>
                    )}
                />

                <Spacer height={20} />
            </ScrollView>

            {/* --- N√∫t b√°o gi√° --- */}
            <View style={styles.buttonContainer}>
                <Button
                    title="B√°o gi√°"
                    containerStyle={styles.button}
                    onPress={() => setIsModalVisible(true)}
                />
            </View>

            {/* --- Modal g·ª≠i b√°o gi√° --- */}
            <CustomModal
                visible={isModalVisible}
                onClose={() => setIsModalVisible(false)}
                configHeight={0.8}
            >
                <ScrollView showsVerticalScrollIndicator={false}>
                    <Text style={[DefaultStyles.textBold16Black, { marginBottom: 16 }]}>
                        G·ª≠i b√°o gi√°
                    </Text>

                    <Input
                        title="Ghi ch√∫"
                        value={note}
                        area
                        onChangeText={(text) => setNote(text)}
                        placeholder="Nh·∫≠p ghi ch√∫ c·ªßa b·∫°n"
                    />
                    <Spacer height={14} />

                    <Input
                        title="B√°o gi√° (VNƒê)"
                        keyboardType="number-pad"
                        value={price}
                        onChangeText={(text) => setPrice(formatCurrency(text))}
                        placeholder="Nh·∫≠p s·ªë ti·ªÅn"
                    />
                    <Spacer height={20} />
                </ScrollView>

                <View>
                    <Button title="X√°c nh·∫≠n" onPress={handleApplicant} disable={!price.trim()} />
                </View>
            </CustomModal>
        </SafeAreaView>
    )
}

export default DetailOrderView

const styles = StyleSheet.create({
    content: {
        flex: 1,
        paddingHorizontal: 16,
        paddingTop: 16,
    },
    serviceCard: {
        backgroundColor: Colors.whiteF2,
        borderRadius: 12,
        padding: 14,
        marginBottom: 16,
        borderLeftWidth: 4,
        borderLeftColor: Colors.primary700,
    },
    serviceHeader: {
        flexDirection: 'row',
        alignItems: 'flex-start',
        justifyContent: 'space-between',
        gap: 12,
    },
    section: {
        marginBottom: 18,
    },
    priceBox: {
        backgroundColor: Colors.whiteF2,
        paddingHorizontal: 12,
        paddingVertical: 10,
        borderRadius: 8,
        borderLeftWidth: 3,
        borderLeftColor: Colors.green34,
    },
    imageItem: {
        width: 120,
        height: 120,
        borderRadius: 8,
        marginRight: 12,
        marginLeft: 16,
    },
    buttonContainer: {
        paddingHorizontal: 16,
        paddingBottom: 20,
        paddingTop: 12,
        borderTopWidth: 1,
        borderTopColor: Colors.grayDE,
    },
    button: {
        margin: 0,
    },
    headerIndicator: {
        position: 'absolute',
        top: 50,
        alignSelf: 'center',
        backgroundColor: 'rgba(0,0,0,0.4)',
        paddingHorizontal: 10,
        paddingVertical: 4,
        borderRadius: 10,
    },
    indicatorText: {
        color: 'white',
        fontSize: 14,
    },
})
